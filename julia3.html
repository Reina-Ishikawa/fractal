<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>インタラクティブ・ジュリア集合（学園祭デモ・完全動作版）</title>
  <style>
    :root{
      --panel-bg: rgba(20,22,28,0.86);
      --accent: #7dd3fc;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    html, body { height: 100%; margin: 0; background: #030712; color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif; }
    #wrap { position: fixed; inset: 0; display: grid; grid-template-columns: 320px 1fr; }
    #panel { padding: 16px; background: var(--panel-bg); backdrop-filter: blur(8px); overflow: auto; border-right: 1px solid rgba(255,255,255,0.06); }
    #canvas { width: 100%; height: 100%; display: block; }
    h1{ font-size: 18px; margin: 0 0 6px; letter-spacing: .03em; }
    .sub{ font-size: 12px; color: var(--muted); margin-bottom: 12px; }
    .row{ margin: 10px 0 14px; }
    label{ display:flex; justify-content:space-between; align-items:center; font-size: 12px; color: var(--muted); }
    input[type="range"]{ width: 100%; }
    input[type="number"]{ width: 110px; background: #0b1220; color: var(--text); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 6px 8px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn{ cursor:pointer; border:1px solid rgba(255,255,255,0.12); background: #0b1220; color: var(--text); padding: 8px 10px; border-radius: 12px; font-weight: 600; font-size: 12px; letter-spacing:.02em; }
    .btn:hover{ border-color: rgba(255,255,255,0.28); }
    .btn.accent{ border-color: var(--accent); box-shadow: 0 0 0 1px rgba(125,211,252,0.2) inset; }
    .footer{ margin-top: 10px; font-size: 11px; color: var(--muted); }
    .preset{ display:flex; flex-wrap: wrap; gap: 6px; }
    .chip{ cursor:pointer; border:1px solid rgba(255,255,255,0.15); padding:6px 8px; border-radius: 999px; font-size: 11px; background:#0b1220; color: #fff; }
    .chip:hover{ border-color: var(--accent); background:#1e293b; }
    .row small{ color: var(--muted); }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="panel">
      <h1>ジュリア集合</h1>
      <div class="sub">z → z² + c の反復で現れる複雑なパターン。数値 c を変えると図形が劇的に変わります。</div>
      <div class="row">
        <label>複素数 c（実部 / 虚部）</label>
        <div class="grid">
          <div>
            <label>Re(c): <span id="reVal">-0.8</span></label>
            <input id="re" type="range" min="-1.5" max="1.5" step="0.001" value="-0.8" />
          </div>
          <div>
            <label>Im(c): <span id="imVal">0.156</span></label>
            <input id="im" type="range" min="-1.5" max="1.5" step="0.001" value="0.156" />
          </div>
        </div>
        <div class="grid" style="margin-top:8px;">
          <input id="reNum" type="number" step="0.001" value="-0.8" />
          <input id="imNum" type="number" step="0.001" value="0.156" />
        </div>
      </div>
      <div class="row">
        <label>最大反復回数（精細さ）: <span id="iterVal">300</span></label>
        <input id="iter" type="range" min="50" max="2000" step="10" value="300" />
      </div>
      <div class="row">
        <label>カラーパレット</label>
        <div class="grid">
          <button class="btn" data-palette="0">スムース</button>
          <button class="btn" data-palette="1">青系</button>
          <button class="btn" data-palette="2">レインボー</button>
          <button class="btn" id="shuffle">ランダム彩色</button>
        </div>
      </div>
      <div class="row">
        <label>表示</label>
        <div class="grid">
          <button class="btn accent" id="reset">リセット</button>
          <button class="btn" id="save">画像を保存</button>
        </div>
        <small>マウスでドラッグ：移動 / ホイール：ズーム / ダブルクリック：その場所へズーム</small>
      </div>
      <div class="row">
        <label>おすすめ c（クリックで反映）</label>
        <div class="preset" id="presets"></div>
      </div>
      <div class="footer">WebGL完全動作版：スライダー・数値入力・カラーパレット・ズーム対応</div>
    </div>
    <canvas id="canvas"></canvas>
  </div>
  <script>
  const canvas = document.getElementById('canvas');
  const gl = canvas.getContext('webgl');
  if(!gl){ alert('WebGLを利用できません。'); }

  const vertSrc = `
    attribute vec2 a_pos;
    varying vec2 v_uv;
    void main(){ v_uv = a_pos * 0.5 + 0.5; gl_Position = vec4(a_pos,0.0,1.0); }
  `;

  const fragSrc = `
    precision highp float;
    varying vec2 v_uv;
    uniform float u_aspect; uniform vec2 u_center; uniform float u_zoom; uniform vec2 u_c; uniform int u_iter; uniform int u_palette; uniform vec3 u_rand;
    vec3 palette(float t, int mode){
      if(mode==0) return 0.5 + 0.5*cos(6.28318*(vec3(0.0,0.33,0.67)+t));
      else if(mode==1) return vec3(0.1,0.2,0.4)+vec3(0.0,0.3,0.7)*t;
      else return vec3(0.5+0.5*sin(6.28318*(t)),0.5+0.5*sin(6.28318*(t+0.33)),0.5+0.5*sin(6.28318*(t+0.67)));
    }
    void main(){
      vec2 p=(v_uv*2.0-1.0); p.x*=u_aspect; p=u_center+p/u_zoom;
      float zx=p.x,zy=p.y; float escape2=4.0; int i;
      for(int j=0;j<2000;j++){ if(j>=u_iter) break; float x2=zx*zx-zy*zy+u_c.x; float y2=2.0*zx*zy+u_c.y; zx=x2; zy=y2; if(zx*zx+zy*zy>escape2){i=j;break;} i=j; }
      float t; if(i>=u_iter-1) gl_FragColor=vec4(vec3(0.02),1.0); else { float x=zx,y=zy; float x2=x*x-y*y+u_c.x; float y2=2.0*x*y+u_c.y; float mag=sqrt(x2*x2+y2*y2); float mu=float(i)+1.0-log2(log2(max(mag,1e-6))); t=mu/float(u_iter); t=fract(t+u_rand.x*0.37+u_rand.y*0.13); vec3 col=palette(t,u_palette); gl_FragColor=vec4(col,1.0);} }
  `;

  function compile(type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))throw new Error(gl.getShaderInfoLog(s));return s;}
  function program(vs,fs){const p=gl.createProgram();gl.attachShader(p,vs);gl.attachShader(p,fs);gl.linkProgram(p);if(!gl.getProgramParameter(p,gl.LINK_STATUS))throw new Error(gl.getProgramInfoLog(p));return p;}

  const prog=program(compile(gl.VERTEX_SHADER,vertSrc),compile(gl.FRAGMENT_SHADER,fragSrc)); gl.useProgram(prog);
  const a_pos=gl.getAttribLocation(prog,'a_pos'); const quad=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,quad);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);
  gl.enableVertexAttribArray(a_pos); gl.vertexAttribPointer(a_pos,2,gl.FLOAT,false,0,0);

  const U={aspect:gl.getUniformLocation(prog,'u_aspect'),center:gl.getUniformLocation(prog,'u_center'),zoom:gl.getUniformLocation(prog,'u_zoom'),c:gl.getUniformLocation(prog,'u_c'),iter:gl.getUniformLocation(prog,'u_iter'),palette:gl.getUniformLocation(prog,'u_palette'),rand:gl.getUniformLocation(prog,'u_rand')};

  let state={center:{x:0,y:0},zoom:1.3,c:{re:-0.8,im:0.156},iter:300,palette:0,rand:[Math.random(),Math.random(),Math.random()]};

  function resize(){const dpr=Math.min(window.devicePixelRatio||1,2.5);const w=canvas.clientWidth=canvas.parentElement.clientWidth;const h=canvas.clientHeight=canvas.parentElement.clientHeight;canvas.width=Math.floor(w*dpr);canvas.height=Math.floor(h*dpr);gl.viewport(0,0,canvas.width,canvas.height);gl.uniform1f(U.aspect,canvas.width/canvas.height);draw();}
  window.addEventListener('resize',resize);

  function draw(){gl.uniform2f(U.center,state.center.x,state.center.y);gl.uniform1f(U.zoom,state.zoom);gl.uniform2f(U.c,state.c.re,state.c.im);gl.uniform1i(U.iter,state.iter|0);gl.uniform1i(U.palette,state.palette|0);gl.uniform3f(U.rand,state.rand[0],state.rand[1],state.rand[2]);gl.drawArrays(gl.TRIANGLES,0,6);}

  // --- UI control ---
  const re=document.getElementById('re'),im=document.getElementById('im'),reNum=document.getElementById('reNum'),imNum=document.getElementById('imNum'),reVal=document.getElementById('reVal'),imVal=document.getElementById('imVal'),iter=document.getElementById('iter'),iterVal=document.getElementById('iterVal');
  function setC(rev,imv){state.c.re=parseFloat(rev);state.c.im=parseFloat(imv);re.value=reNum.value=state.c.re;im.value=imNum.value=state.c.im;reVal.textContent=state.c.re.toFixed(3);imVal.textContent=state.c.im.toFixed(3);draw();}
  re.addEventListener('input',e=>setC(e.target.value,im.value)); im.addEventListener('input',e=>setC(re.value,e.target.value)); reNum.addEventListener('change',e=>setC(e.target.value,imNum.value)); imNum.addEventListener('change',e=>setC(reNum.value,e.target.value));
  iter.addEventListener('input',e=>{state.iter=parseInt(e.target.value,10);iterVal.textContent=state.iter;draw();});
  document.querySelectorAll('[data-palette]').forEach(btn=>btn.addEventListener('click',()=>{state.palette=parseInt(btn.dataset.palette,10);draw();}));
  document.getElementById('shuffle').addEventListener('click',()=>{state.rand=[Math.random(),Math.random(),Math.random()];draw();});
  document.getElementById('reset').addEventListener('click',()=>{state.center={x:0,y:0};state.zoom=1.3;draw();});
  document.getElementById('save').addEventListener('click',()=>{const link=document.createElement('a');link.download=`julia_c(${state.c.re.toFixed(3)},${state.c.im.toFixed(3)})_iter${state.iter}.png`;link.href=canvas.toDataURL('image/png');link.click();});

  // mouse move zoom
  let dragging=false,last={x:0,y:0}; canvas.addEventListener('mousedown',e=>{dragging=true;last={x:e.clientX,y:e.clientY};}); window.addEventListener('mouseup',()=>dragging=false);
  window.addEventListener('mousemove',e=>{if(!dragging)return;const dx=e.clientX-last.x,dy=e.clientY-last.y;last={x:e.clientX,y:e.clientY};const scale=1.0/state.zoom;const ax=(dx/canvas.height)*(canvas.width/canvas.height);const ay=(dy/canvas.height);state.center.x-=ax*scale;state.center.y+=ay*scale;draw();});
  canvas.addEventListener('wheel',e=>{e.preventDefault();const rect=canvas.getBoundingClientRect();const mx=(e.clientX-rect.left)/rect.width,my=(e.clientY-rect.top)/rect.height;const aspect=canvas.width/canvas.height;const px=(mx*2-1)*aspect,py=(my*2-1);const before={x:state.center.x+px/state.zoom,y:state.center.y+py/state.zoom};const factor=Math.exp(-e.deltaY*0.0015);state.zoom*=factor;const after={x:state.center.x+px/state.zoom,y:state.center.y+py/state.zoom};state.center.x+=(before.x-after.x);state.center.y+=(before.y-after.y);draw();},{passive:false});
  canvas.addEventListener('dblclick',e=>{const rect=canvas.getBoundingClientRect();const mx=(e.clientX-rect.left)/rect.width,my=(e.clientY-rect.top)/rect.height;const aspect=canvas.width/canvas.height;const px=(mx*2-1)*aspect,py=(my*2-1);state.center.x+=px/state.zoom;state.center.y+=py/state.zoom;state.zoom*=1.8;draw();});

  const presets=[{name:'-0.8 + 0.156i',re:-0.8,im:0.156},{name:'0.285 + 0.000i',re:0.285,im:0.0},{name:'-0.4 + 0.6i',re:-0.4,im:0.6},{name:'-0.70176 - 0.3842i',re:-0.70176,im:-0.3842},{name:'-0.75 + 0.11i',re:-0.75,im:0.11},{name:'-0.12 + 0.74i',re:-0.12,im:0.74},{name:'0.28 + 0.008i',re:0.28,im:0.008}];
  const presetEl=document.getElementById('presets');presets.forEach(p=>{const b=document.createElement('button');b.className='chip';b.textContent=p.name;b.addEventListener('click',()=>setC(p.re,p.im));presetEl.appendChild(b);});

  resize(); setC(state.c.re,state.c.im); draw();
  </script>
</body>
</html>
